name: "CI tests"

on: [ push, workflow_dispatch ]

jobs:
  build-linux-gcc:
    name: Tests on Linux GCC
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      - name: Create CMake cache
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug

      - name: Build all
        run: |
          cmake --build build --parallel 4

      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure

  build-windows-msvc:
    name: Tests on Windows MSVC
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Configure CMake
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build --config Release --parallel 4

      - name: Run tests
        run: |
          cd build
          if [ -f "./tests/Debug/cpp_tests_tests.exe" ]; then
            ./tests/Debug/cpp_tests_tests.exe
          elif [ -f "./tests/cpp_tests_tests.exe" ]; then
            ./tests/cpp_tests_tests.exe
          elif [ -f "./Debug/cpp_tests_tests.exe" ]; then
            ./Debug/cpp_tests_tests.exe
          else
            echo "Test executable not found"
            exit 1
          fi

  build-macos-clang:
    name: Tests on macOS Clang
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Create CMake cache
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug

      - name: Build
        run: |
          cmake --build build --parallel 4

      - name: Run tests
        run: |
          cd build
          ./tests/cpp_tests_tests

  build-windows-mingw:
    name: Tests on Windows MinGW
    runs-on: windows-latest
    if: false  # Отключено, так как есть проблемы с MinGW

    steps:
      - uses: actions/checkout@v4

      - name: Setup MinGW
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: mingw-w64-x86_64-gcc mingw-w64-x86_64-cmake mingw-w64-x86_64-make

      - name: Build with MinGW
        shell: msys2 {0}
        run: |
          cmake -S . -B build -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Debug
          cmake --build build --parallel 4

      - name: Run tests
        shell: msys2 {0}
        run: |
          cd build
          ./tests/cpp_tests_tests.exe

  memory-check:
    name: Memory check with Valgrind
    runs-on: ubuntu-latest
    needs: [build-linux-gcc]

    steps:
      - uses: actions/checkout@v4

      - name: Install Valgrind
        run: |
          sudo apt-get update
          sudo apt-get install -y valgrind

      - name: Build with debug info
        run: |
          cmake -S . -B build-debug -DCMAKE_BUILD_TYPE=Debug
          cmake --build build-debug --parallel 4

      - name: Run Valgrind
        run: |
          cd build-debug/tests
          valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes --error-exitcode=1 ./cpp_tests_tests

  style-check:
    name: Code style check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check formatting
        run: |
          # Проверяем наличие clang-format
          if ! command -v clang-format &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y clang-format
          fi

          # Проверяем форматирование
          find . -name "*.cpp" -o -name "*.hpp" -o -name "*.c" -o -name "*.h" \
            | xargs clang-format --dry-run --Werror

  quality-check:
    name: Code quality check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install clang-tidy
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-tidy

      - name: Generate compile commands
        run: |
          cmake -S . -B build-tidy -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Run clang-tidy
        run: |
          # Находим файлы для проверки
          find . -name "*.cpp" -type f \
            | xargs -I {} clang-tidy {} -p build-tidy/compile_commands.json \
            --checks='-*,bugprone-*,performance-*,readability-*,modernize-*' \
            --warnings-as-errors='*'

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [build-linux-gcc, build-windows-msvc, build-macos-clang, style-check, quality-check]
    if: always()

    steps:
      - name: Status Summary
        run: |
          echo "## CI Pipeline Summary"
          echo ""
          echo "| Job | Status |"
          echo "|-----|--------|"
          echo "| Linux GCC Tests | ${{ needs.build-linux-gcc.result }} |"
          echo "| Windows MSVC Tests | ${{ needs.build-windows-msvc.result }} |"
          echo "| macOS Clang Tests | ${{ needs.build-macos-clang.result }} |"
          echo "| Code Style Check | ${{ needs.style-check.result }} |"
          echo "| Code Quality Check | ${{ needs.quality-check.result }} |"
          echo ""
          echo "**Overall Status:** ${{ job.status }}"